<!DOCTYPE html>
<html class="x-admin-sm">

<head>
<meta charset="UTF-8">
<title>欢迎页面-X-admin2.2</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
<link rel="stylesheet" href="../css/font.css">
<link rel="stylesheet" href="../css/xadmin.css">
<script src="../lib/layui/layui.js" charset="utf-8"></script>
<script type="text/javascript" src="../js/xadmin.js"></script>
<script type="text/javascript" src="../js/jquery.min.js"></script>
<script type="text/javascript" srec="../lib/layui/lay/modules/laydate.js"></script>
</head>

<body>
	<div class="x-nav">
		<a class="layui-btn layui-btn-small"
			style="line-height: 1.6em; margin-top: 3px; float: right"
			onclick="location.reload()" title="刷新"> <i
			class="layui-icon layui-icon-refresh" style="line-height: 30px"></i>
		</a>
	</div>
	<div class="layui-fluid">
		<div class="layui-row layui-col-space15">
			<div class="layui-col-md12">
				<div class="layui-card">
					<div class="layui-card-body ">
						<form class="layui-form layui-col-space5">
							<div class="layui-input-inline">
						        <input type="text" class="layui-input" id="test6" placeholder="日期范围">
						    </div>
							<div class="layui-input-inline">
								<select name="user" id="user" lay-search
									lay-filter="Person_filter" class="layui-input">
									<option value="">操作人员</option>
								</select>
							</div>
							<div class="layui-input-inline">
								<select name="status" id="status" lay-search
									lay-filter="Status_filter" lay-verify="select_base_status"
									class="layui-input">
									<option value="">具体操作</option>
									<option value="20">入院</option>
									<option value="30">出库</option>
									<option value="40">借用</option>
									<option value="70">故障</option>
								</select>
							</div>
							<div class="layui-inline layui-show-xs-block">
								<div class="layui-btn" data-type="reload" lay-submit=""
									lay-filter="sreach">
									<i class="layui-icon">&#xe615;</i>
								</div>
							</div>
						</form>
					</div>
					<div class="layui-card-body ">
						<table class="layui-table" id="LAY_table_equipment"
							lay-filter="test"></table>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script>
	layui.use('laydate', function() {
		var laydate = layui.laydate;
		 //日期范围
		  laydate.render({
		    elem: '#test6'
		    ,range: true
		  });
	});
</script>
<script type="text/html" id="barDemo">
		<div class="layui-btn-container">
		<a title="详情" class="layui-btn layui-btn-normal layui-btn-mini" lay-event="details" onclick="" href="javascript:;">详情</a>
		<a title="编辑" class="layui-btn layui-btn-mini" lay-event="edit" onclick="" href="javascript:;">停单</a>
		</div>	
</script>
<script>
layui.use(['form','table','jquery'], function() {
	$ = layui.jquery;
	var table = layui.table;
	//方法级渲染
    table.render({
        elem: '#LAY_table_equipment'
        ,url: 'changeForm/findChangeFormByPage'
        ,cellMinWidth: 100
        ,cols: [[
            {checkbox: true, fixed: true}
            ,{field:'id', title: 'ID', width:80, sort: true,align:'center'}
            ,{field:'username', title: '操作人员', width:150, sort: true,align:'center'}
            ,{field:'type', title: '具体操作', width:100, sort: true,align:'center'}
            ,{field:'f_date', title: '操作时间', width:150, sort: true,align:'center'}
            ,{field:'delete_tag', title: '是否停单', sort: true, width:140,align:'center',templet : function (d) {
	                if (d.delete_tag === false) {
	                    return "<span title='未停单' class='layui-btn layui-btn-normal  layui-btn-mini'>未停单</span>"
	                }else {
	                	return "<span title='已停单' class='layui-btn layui-btn-danger  layui-btn-mini'>已停单</span>"
	                }
                }
            }
            ,{fixed: 'right', title: '操作',align:'center', width:200,toolbar:'#barDemo'}
        ]]
  		,page: true //是否显示分页
  		,limits:[5,10,15,20,50,100]
   		,limit: 10 //每页默认显示的数量
        ,id: 'testReload'
        ,response: {
        	statusCode: 200 //规定成功的状态码，默认：0
        }
        ,height: 516
    });
    active = {
 	    reload: function(){
 	      var changeTime = $('#test6');
 	      var user = $('#user');
 	      var status = $('#status');
 	      //执行重载
 	      table.reload('testReload', {
 	    	url: 'changeForm/findChangeFormByPage'
 	        ,method:'get'
 	        ,page: {
 	          curr: 1 //重新从第 1 页开始
 	        }
 	        ,where: {
 	        	 user: user.val(),
 	        	 status: status.val(),
 	        	 change_time: changeTime.val()
 	        }
 	      });
 	    }
 	  };
 	 $('.layui-card-body .layui-btn').on('click', function(){
 	    var type = $(this).data('type');
 	    active[type] ? active[type].call(this) : '';
 	  });
	var form = layui.form;
	$(document).ready(function() {　　
		$.ajax({
			type : "post",
			url : "user/findAllUsers",
			dataType : "json",
			success: function(data) {
				$.each(data.data, function(i, item) {
					$('#user').append(new Option(item.username,item.id));
				});
				form.render("select");
			},
			error:function(){
				
			}
		});
	});
	
});
layui.use('laydate', function() {
	var laydate = layui.laydate;

	//执行一个laydate实例
	laydate.render({
		elem : '#start' //指定元素
	});

	//执行一个laydate实例
	laydate.render({
		elem : '#end' //指定元素
	});

});
</script>
<script>
	/*用户-删除*/
	function member_del(obj, id) {
		layer.confirm('确认要删除吗？', function(index) {
			//发异步删除数据
			$(obj).parents("tr").remove();
			$.ajax({
				//请求方式
				type : "post",
				//url 
				url : "equipment/updateEquimentById",
				data: "id=" + id,
				//datarype 
				dataType : "json",
				//result 为请求的返回结果对象
				success : function(result) {
					if ("200" == result.status) {
						layer.msg('已删除!', {
							icon : 1,
							time : 1000
						});
						location.reload(); 
					} 
				}
			});
		});
	} 
	layui.use('table', function() {
		var table = layui.table;

		//监听工具条
		  table.on('tool(test)', function(obj){
		    var data = obj.data;
		    if(obj.event === 'details'){
		    	console.log(JSON.stringify(data));
		    	layer.open({
	                title: '表单详情',
	                type: 2,
	                area: [ '800px', '627px'], //宽高
	                maxmin: true, //开启最大化最小化按钮
	                content: "toPage?url=/static/form-detail",
	                success: function (layero, index) {
	                    // 获取子页面的iframe
	                    var iframe = window['layui-layer-iframe' + index];
	                    // 向子页面的全局函数child传参
	                    iframe.child(JSON.stringify(data)); 
	                }
              })
		    }
		   if(obj.event === 'edit'){
			   
			   if(data.delete_tag === true){
				   layer.msg('该表单无法停单!', {
						icon : 2,
						time : 2000
					});
			   }else{
				   layer.confirm('真的要停止该表单吗?', function(index){
					   $.ajax({
							//请求方式
							type : "get",
							//url 
							url : "changeForm/updateChangeFormById",
							data: "id=" + data.id,
							//datarype 
							dataType : "json",
							//result 为请求的返回结果对象
							success : function(result) {
								if ("200" == result.status) {
									layer.msg('已停单!', {
										icon : 1,
										time : 2000
									});
									location.reload();
								} 
								 
							}
						}); 
				   });
			   } 
		    }
		  });

		//头工具栏事件
		table.on('toolbar(test)', function(obj) {
			var checkStatus = table.checkStatus(obj.config.id);
			switch (obj.event) {
			case 'getCheckData':
				var data = checkStatus.data;
				if(data.length <= 0){
					layer.alert("请先选择数据!");
				}else{
					for(var i=0;i < data.length;i++){
						if(i == data.length-1){
							if(data[i].status != data[0].status){//比较最后一个和第一个的数据
								layer.alert("选择的数据状态不一致!");
								return;
							}
						}else{
							if(data[i].status != data[i+1].status){//比较中间的数据
								layer.alert("选择的数据状态不一致!");
								return;
							}
						}
					}
					layer.open({
		                title: '批量修改状态',
		                type: 2,
		                area: [ '800px', '600px'], //宽高
		                maxmin: true, //开启最大化最小化按钮
		                content: "toPage?url=/static/update-status",
		                success: function (layero, index) {
		                    // 获取子页面的iframe
		                    var iframe = window['layui-layer-iframe' + index];
		                    // 向子页面的全局函数child传参
		                    iframe.child(JSON.stringify(data)); 
		                }
		            })
				}
				break;
			}
			;
		});
	});
</script>
</html>